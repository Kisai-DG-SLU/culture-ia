name: CI-CD-Pipeline

on:
  push:
    branches:
      - '**' # Se déclenche sur toutes les branches

# Permissions étendues pour permettre le merge et le push de tags
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    outputs:
      should_merge: ${{ steps.check_merge.outputs.should_merge }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Nécessaire pour le merge et les tags

    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: "3.10"
        activate-environment: culture-ia
        environment-file: environment.yml
        auto-activate-base: false

    - name: Verify Environment
      shell: bash -l {0}
      run: |
        conda info
        conda list

    - name: Check Code Format (Black)
      shell: bash -l {0}
      run: |
        make format
        git diff --exit-code || (echo "❌ Code not formatted." && exit 1)

    - name: Linting
      shell: bash -l {0}
        run: | # Désactiver C0111, C0103, R0903, W0718, W0621, W0613, R0913, R0917, R0914, C0301
          .venv_conda/bin/pylint src/ tests/ --disable=C0111,C0103,R0903,W0718,W0621,W0613,R0913,R0917,R0914,C0301

    - name: Run Tests with Coverage Gate (70%)
      shell: bash -l {0}
      env:
        # Secrets mockés ou réels selon besoin
        MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        MOCK_DATA: "true"
      run: |
        # pytest.ini contient --cov-fail-under=70, donc ça échouera si < 70%
        echo "MISTRAL_API_KEY=$MISTRAL_API_KEY" > .env
        make test

    - name: Upload Coverage Artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-xml
        path: coverage.xml

    - name: Upload HTML Report to Pages Artifact
      if: github.ref == 'refs/heads/main' || steps.check_merge.outputs.should_merge == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: htmlcov/

    - name: Check if merge required
      id: check_merge
      # On ne merge que si ce n'est PAS main, et si succès précédent
      run: |
        if [[ "${{ github.ref }}" != "refs/heads/main" && "${{ github.ref }}" != "refs/heads/test" ]]; then
          echo "should_merge=true" >> $GITHUB_OUTPUT
        else
          echo "should_merge=false" >> $GITHUB_OUTPUT
        fi

  auto-merge-and-version:
    needs: quality-gate
    if: needs.quality-gate.outputs.should_merge == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

    - name: Merge Logic
      env:
        HAS_TEST_ENV: ${{ vars.HAS_TEST_ENV }}
        SOURCE_BRANCH: ${{ github.ref_name }}
      run: |
        echo "Source branch: $SOURCE_BRANCH"
        
        if [[ "$HAS_TEST_ENV" == "true" ]]; then
          echo "Environment TEST detected. Merging to 'test' branch."
          TARGET_BRANCH="test"
        else
          echo "No TEST environment. Merging directly to 'main'."
          TARGET_BRANCH="main"
        fi
        
        # Récupérer et switcher sur la branche cible
        git fetch origin $TARGET_BRANCH:$TARGET_BRANCH || git checkout -b $TARGET_BRANCH origin/$TARGET_BRANCH || git checkout -b $TARGET_BRANCH
        git checkout $TARGET_BRANCH
        
        # Merge de la branche source
        echo "Merging $SOURCE_BRANCH into $TARGET_BRANCH..."
        git merge origin/$SOURCE_BRANCH --no-ff -m "Merge $SOURCE_BRANCH into $TARGET_BRANCH via CI"
        
        # Push
        git push origin $TARGET_BRANCH

    - name: Bump Version (Only if merging to main)
      if: vars.HAS_TEST_ENV != 'true' # Si on merge direct sur main, on versionne
      run: |
        # On est déjà sur main suite au step précédent
        chmod +x scripts/bump_version.sh
        ./scripts/bump_version.sh

  deploy-pages:
    needs: quality-gate
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
